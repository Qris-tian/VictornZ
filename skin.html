<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pasang Skin</title>
  <link rel="stylesheet" href="skin.css">
  <link rel="stylesheet" href="sidebar.css">
</head>
<body data-title="Pasan Skin">

<div id="sidebar-container"></div>

<!-- KONTEN PASANG SKIN -->
<div class="content">
  <h1><b>Pasang<br>Template</b></h1>

  <div class="ytta">
    <label><b>Pilih resolusi :</b></label>
    <select id="model">
      <option value="64">64 Pixel (Standar)</option>
      <option value="128">128 Pixle (HD)</option>
    </select>
  </div>

  <div class="ytta">
    <label><b>Upload Skin :</b></label>
    <input type="file" id="skinInput" accept="image/png"><br>
  </div>

  <button id="processBtn">Pasang Baju</button>
  <button id="downloadBtn" disabled>Download Skin</button>

  <div id="progressContainer">
    <div id="progressBar"></div>
  </div>
  <div id="statusText"></div>

  <canvas id="canvas" width="64" height="64"></canvas>
</div>

<!-- SCRIPT SIDEBAR -->
<script>
/* ======================================================
   LOAD SIDEBAR + FUNGSI-FUNGSI
====================================================== */
fetch('sidebar.html')
  .then(res => res.text())
  .then(html => {
    document.getElementById('sidebar-container').innerHTML = html;

    const sidebar = document.querySelector('.sidebar');
    const menuBtn = document.getElementById('menuBtn');

    /* SIDEBAR TOGGLE + ANIMASI MENU BTN */
    menuBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      sidebar.classList.toggle('active');
      menuBtn.classList.toggle('active'); // animasi garis → panah
    });

    document.addEventListener('click', (e) => {
      if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
        sidebar.classList.remove('active');
        menuBtn.classList.remove('active'); // reset animasi
      }
    });

    document.querySelectorAll('.sidebar a').forEach(link => {
      link.addEventListener('click', () => {
        sidebar.classList.remove('active');
        menuBtn.classList.remove('active'); // reset animasi
      });
    });

    /* MENANDAI HALAMAN AKTIF */
    const currentPage = window.location.pathname.split('/').pop();
    document.querySelectorAll('.sidebar a').forEach(link => {
      const target = link.getAttribute('href');
      link.classList.remove('active');
      if (target === currentPage) link.classList.add('active');
    });

    /* SET JUDUL HEADER */
    const pageTitle = document.getElementById("pageTitle");
    if (pageTitle) {
      pageTitle.textContent = document.body.getAttribute("data-title");
    }
  });

</script>

<!-- SCRIPT PASANG SKIN DENGAN VALIDASI RESOLUSI -->
<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const skinInput = document.getElementById("skinInput");
const processBtn = document.getElementById("processBtn");
const downloadBtn = document.getElementById("downloadBtn");
const modelSelect = document.getElementById("model");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const statusText = document.getElementById("statusText");

function updateProgress(percent, text) {
  progressContainer.style.display = "block";
  progressBar.style.width = percent + "%";
  statusText.textContent = text;
}

function readFile(input, callback) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = e => callback(e.target.result);
    reader.readAsDataURL(input.files[0]);
  }
}

processBtn.addEventListener("click", () => {
  if (!skinInput.files[0]) {
    alert("Silakan upload file skin dulu!");
    return;
  }

  const res = modelSelect.value;
  const outfitImg = new Image();
  outfitImg.src = res === "128" ? "template/128px.png" : "template/64px.png";

  readFile(skinInput, (skinSrc) => {
    const skinImg = new Image();
    skinImg.onload = () => {
      const width = skinImg.width;
      const height = skinImg.height;

      // Validasi ukuran skin
      if ((width !== 64 && width !== 128) || (height !== 64 && height !== 128)) {
        updateProgress(0, "❌ Skin tidak valid. Pastikan ukurannya 64x64 atau 128x128.");
        return;
      }

      // Cek apakah resolusi sesuai dengan pilihan
      if (res === "64" && width === 128) {
        updateProgress(0, "⚠️ Skin ini beresolusi 128px. Ubah pilihan di atas ke 128px.");
        return;
      } else if (res === "128" && width === 64) {
        updateProgress(0, "⚠️ Skin ini beresolusi 64px. Ubah pilihan di atas ke 64px.");
        return;
      }

      updateProgress(50, "Memproses skin...");

      outfitImg.onload = () => {
        canvas.width = width;
        canvas.height = height;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(skinImg, 0, 0, width, height);
        ctx.clearRect(16, 32, 24, 16);
        ctx.clearRect(40, 32, 16, 16);
        ctx.clearRect(48, 48, 16, 16);
        ctx.drawImage(outfitImg, 0, 0, width, height);

        updateProgress(100, "✅ Selesai! Klik Download.");
        downloadBtn.disabled = false;
      };
    };

    skinImg.onerror = () => {
      updateProgress(0, "❌ File skin tidak valid.");
    };

    skinImg.src = skinSrc;
  });
});

downloadBtn.addEventListener("click", () => {
  const link = document.createElement("a");
  link.download = "TemplatVictornZ.png";
  link.href = canvas.toDataURL("image/png");
  link.click();
});
</script>

</body>
</html>